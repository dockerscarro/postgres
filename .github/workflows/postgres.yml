name: CI Test (Docker Build + SSH Check)

on:
  push:
    branches:
      - qa

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # 1Ô∏è‚É£ Checkout Code
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # 2Ô∏è‚É£ Build Docker Image (Local in Runner)
      # -----------------------------
      - name: Build Docker Image
        run: |
          echo "üî® Building Docker image in GitHub runner..."
          docker build -t hubspot-sync:test .
          echo "‚úÖ Docker image built successfully"

      # -----------------------------
      # 3Ô∏è‚É£ Setup SSH
      # -----------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      # -----------------------------
      # 4Ô∏è‚É£ Test Server Connection
      # -----------------------------
      - name: Test SSH Connection
        run: |
          echo "üîç Testing SSH connection to server..."

          if ssh -o StrictHostKeyChecking=no \
             -o ConnectTimeout=10 \
             -p ${{ secrets.SERVER_PORT }} \
             ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
             "echo '‚úÖ Server connection successful'" ; then

             echo "üéâ SERVER CONNECTION: SUCCESS"
          else
             echo "‚ùå SERVER CONNECTION: FAILED"
             exit 1
          fi

